<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® Redis ç·šä¸ŠéŠæˆ²å•†åº—ï¼ˆå¤šäººåŒæ­¥ç‰ˆï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #667eea;
            font-size: 2em;
        }

        .player-info {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }

        .gold {
            color: #f59e0b;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-actions button {
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }

        .btn-logout {
            background: #ef4444;
            color: white;
        }

        .btn-switch {
            background: #e5e7eb;
            color: #374151;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .click-section {
            text-align: center;
        }

        #clickButton {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            border: none;
            color: white;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
            transition: all 0.3s;
            margin: 20px auto;
            display: block;
        }

        #clickButton:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.6);
        }

        #clickButton:active:not(:disabled) {
            transform: scale(0.95);
        }

        #clickButton:disabled {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
            cursor: not-allowed;
        }

        .click-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .click-stat {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .click-stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }

        .click-stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .item-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s;
        }

        .item-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .item-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #333;
        }

        .item-price {
            color: #f59e0b;
            font-weight: bold;
            font-size: 1.2em;
            margin: 8px 0;
        }

        .item-stats {
            font-size: 0.9em;
            color: #666;
            margin: 5px 0;
        }

        .item-stock {
            color: #10b981;
            font-size: 0.9em;
        }

        button.buy-btn {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s;
        }

        button.buy-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        button.buy-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .inventory-item {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #e5e7eb;
        }

        .inventory-item button {
            padding: 6px 12px;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }

        .inventory-item button:hover {
            background: #d97706;
        }

        .auction-item {
            background: #fef3c7;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 2px solid #fbbf24;
        }

        .auction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .auction-item-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #92400e;
        }

        .auction-price {
            color: #f59e0b;
            font-weight: bold;
            font-size: 1.3em;
        }

        .auction-seller {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .auction-actions {
            display: flex;
            gap: 10px;
        }

        .auction-actions button {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .bid-btn {
            background: #10b981;
            color: white;
        }

        .bid-btn:hover {
            background: #059669;
        }

        .bid-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }

        .modal-content h3 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .confirm-btn {
            background: #667eea;
            color: white;
        }

        .confirm-btn:hover {
            background: #5568d3;
        }

        .cancel-btn {
            background: #e5e7eb;
            color: #666;
        }

        .cancel-btn:hover {
            background: #d1d5db;
        }

        .leaderboard-entry {
            background: #f9fafb;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rank {
            font-weight: bold;
            color: #667eea;
            font-size: 1.2em;
            min-width: 40px;
        }

        .rank-1 {
            color: #f59e0b;
        }

        .rank-2 {
            color: #c0c0c0;
        }

        .rank-3 {
            color: #cd7f32;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            max-width: 350px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 5px solid #10b981;
        }

        .notification.error {
            border-left: 5px solid #ef4444;
        }

        .notification.critical {
            border-left: 5px solid #f59e0b;
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .bottom-section {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .bottom-section {
                grid-template-columns: 1fr;
            }
        }

        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-card h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .login-card input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .login-card button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
        }

        .login-card button:hover {
            background: #5568d3;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-box {
            background: #0b1120;
            border-radius: 16px;
            padding: 24px 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            color: #e5e7eb;
            text-align: center;
            min-width: 260px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            border: 4px solid #1f2937;
            border-top-color: #fbbf24;
            margin: 0 auto 12px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- ç™»å…¥ç•«é¢ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h2>ğŸ® æ­¡è¿ä¾†åˆ° Redis éŠæˆ²ä¸–ç•Œ</h2>
            <p style="color: #666; margin-bottom: 20px;">è«‹è¼¸å…¥ç©å®¶åç¨±é–‹å§‹éŠæˆ²ï¼ˆåŒåç¨±æœƒç™»å…¥èˆŠå¸³è™Ÿï¼‰</p>
            <input type="text" id="usernameInput" placeholder="è¼¸å…¥ç©å®¶åç¨±" maxlength="20">
            <button onclick="createPlayer()">é–‹å§‹éŠæˆ²</button>
        </div>
    </div>
    <!-- è¼‰å…¥ä¸­ç•«é¢ -->
    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
        <div class="loading-box">
            <div class="spinner"></div>
            <div id="loadingText">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦</div>
        </div>
    </div>


    <div class="container" id="gameContainer" style="display: none;">
        <div class="header">
            <h1>ğŸ® ç·šä¸ŠéŠæˆ²å•†åº—ï¼ˆRedis å¤šäººç‰ˆï¼‰</h1>
            <div class="player-info">
                <div class="stat">
                    <div class="stat-label">ç©å®¶</div>
                    <div class="stat-value" id="playerName">-</div>
                </div>
                <div class="stat">
                    <div class="stat-label">ğŸ’° é‡‘å¹£</div>
                    <div class="stat-value gold" id="playerGold">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">ç­‰ç´š</div>
                    <div class="stat-value" id="playerLevel">1</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-switch" onclick="switchAccount()">åˆ‡æ›å¸³è™Ÿ</button>
                <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <div class="main-content">
            <div class="card">
                <h2>ğŸ’° é»æ“Šçˆ†é‡‘å¹£ï¼ˆå¤šäººå…±ç”¨æ’è¡Œæ¦œï¼‰</h2>
                <div class="click-section">
                    <button id="clickButton" onclick="clickForGold()">
                        é»æˆ‘<br>è³ºéŒ¢!
                    </button>
                    <div class="click-stats">
                        <div class="click-stat">
                            <div class="click-stat-value" id="totalClicks">0</div>
                            <div class="click-stat-label">ç¸½é»æ“Š</div>
                        </div>
                        <div class="click-stat">
                            <div class="click-stat-value" id="clickCombo">0</div>
                            <div class="click-stat-label">ç•¶å‰é€£æ“Š</div>
                        </div>
                        <div class="click-stat">
                            <div class="click-stat-value" id="clickRank">-</div>
                            <div class="click-stat-label">é»æ“Šæ’å</div>
                        </div>
                    </div>

                    <!-- ä¼ºæœå™¨å†·å» / é™æµè¨­å®š -->
                    <div id="cooldownInfo" style="margin-top:12px;font-size:0.9em;color:#4b5563;white-space:pre-line;">
                        ä¼ºæœå™¨å†·å»ï¼šæœªçŸ¥ / é™æµè¦–çª—ï¼šæœªçŸ¥
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸª å•†åº—</h2>
                <div class="item-grid" id="shopItems"></div>
            </div>
        </div>

        <div class="bottom-section">
            <div class="card">
                <h2>ğŸ’ æˆ‘çš„èƒŒåŒ…</h2>
                <div id="inventory"></div>
            </div>

            <div class="card">
                <h2>ğŸª æ‹è³£å¸‚å ´ï¼ˆå³æ™‚åŒæ­¥ï¼‰</h2>
                <div id="auctionMarket"></div>
            </div>

            <div class="card">
                <h2>ğŸ† é‡‘å¹£æ’è¡Œæ¦œ</h2>
                <div id="goldLeaderboard"></div>
            </div>
        </div>

        <div style="margin-top: 20px;">
            <div class="card">
                <h2>ğŸ”¥ é»æ“Šæ’è¡Œæ¦œ</h2>
                <div id="clickLeaderboard"></div>
            </div>
        </div>
    </div>

    <!-- æ‹è³£æ¨¡æ…‹æ¡† -->
    <div id="auctionModal" class="modal">
        <div class="modal-content">
            <h3>ğŸª å‰µå»ºæ‹è³£</h3>
            <p style="color: #666; margin-bottom: 15px;">
                ç‰©å“: <strong id="auctionItemName"></strong>
            </p>
            <input type="number" id="auctionPrice" placeholder="è¨­å®šèµ·å§‹åƒ¹æ ¼" min="1">
            <div class="modal-actions">
                <button class="confirm-btn" onclick="confirmAuction()">ç¢ºèªä¸Šæ¶</button>
                <button class="cancel-btn" onclick="closeAuctionModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç«¶æ¨™æ¨¡æ…‹æ¡† -->
    <div id="bidModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ’° ç«¶æ¨™æ‹è³£</h3>
            <p style="color: #666; margin-bottom: 15px;">
                ç‰©å“: <strong id="bidItemName"></strong><br>
                ç•¶å‰åƒ¹æ ¼: <span style="color: #f59e0b; font-weight: bold;" id="bidCurrentPrice">0</span> ğŸ’°
            </p>
            <input type="number" id="bidAmount" placeholder="è¼¸å…¥ä½ çš„å‡ºåƒ¹">
            <div class="modal-actions">
                <button class="confirm-btn" onclick="confirmBid()">ç¢ºèªå‡ºåƒ¹</button>
                <button class="cancel-btn" onclick="closeBidModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        function showLoading(text = "è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦") {
            const overlay = document.getElementById("loadingOverlay");
            const label = document.getElementById("loadingText");
            if (label) label.textContent = text;
            if (overlay) overlay.style.display = "flex";
        }

        function hideLoading() {
            const overlay = document.getElementById("loadingOverlay");
            if (overlay) overlay.style.display = "none";
        }

        // è®“è¼¸å…¥ç©å®¶åç¨±å¾ŒæŒ‰ Enter ä¹Ÿå¯ä»¥ç™»å…¥
        const usernameInput = document.getElementById('usernameInput');
        if (usernameInput) {
            usernameInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    createPlayer();
                }
            });
        }

        const API_BASE = ""; // åŒæº

        let socket = null;
        let shopItemsCache = [];
        let auctionsCache = [];
        let currentAuctionItem = null;
        let currentBidAuctionId = null;

        let gameState = {
            playerId: null,
            username: "",
            gold: 0,
            level: 1,
            inventory: [],
            totalClicks: 0,
            currentCombo: 0
        };

        // å†·å» / é™æµè¨­å®š
        let clickConfig = {
            cooldownMs: 1000,
            windowMs: 1000,
            maxHits: 3,
        };

        function updateCooldownInfo() {
            const el = document.getElementById("cooldownInfo");
            if (!el) return;
            el.textContent =
                `ä¼ºæœå™¨å†·å»ï¼š${clickConfig.cooldownMs} ms\n` +
                `é™æµè¦–çª—ï¼š${clickConfig.windowMs} ms / è¦–çª—å…§æœ€å¤š ${clickConfig.maxHits} é»`;
        }

        async function apiGet(path) {
            const res = await fetch(API_BASE + path);
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                throw { status: res.status, data };
            }
            return data;
        }

        async function apiPost(path, body) {
            const res = await fetch(API_BASE + path, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body || {})
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
                throw { status: res.status, data };
            }
            return data;
        }

        // ç™»å…¥ / å‰µå»ºç©å®¶
        async function createPlayer() {
            const username = document.getElementById("usernameInput").value.trim();
            if (!username) {
                showNotification("è«‹è¼¸å…¥ç©å®¶åç¨±", "error");
                return;
            }

            showLoading("ç™»å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦");

            try {
                const res = await apiPost("/api/player/login", { username });

                gameState.playerId = res.player_id;
                gameState.username = username;

                connectSocket();
                await refreshAll();

                document.getElementById("loginScreen").style.display = "none";
                document.getElementById("gameContainer").style.display = "block";

                showNotification(res.message || "ç™»å…¥æˆåŠŸ", "success");
            } catch (err) {
                showNotification(err.data?.message || "ç™»å…¥å¤±æ•—", "error");
            } finally {
                hideLoading();
            }
        }


        function connectSocket() {
            if (socket) {
                socket.disconnect();
            }
            socket = io();

            socket.on("connect", () => {
                console.log("WebSocket connected");
            });

            socket.on("server_msg", (msg) => {
                console.log(msg.msg);
            });

            socket.on("auction_update", async () => {
                await loadAuctions();
            });

            socket.on("leaderboard_update", async () => {
                await loadLeaderboards();
                await loadPlayer();
            });

            socket.on("config_update", (cfg) => {
                if (!cfg) return;
                if (typeof cfg.cooldown_ms === "number") clickConfig.cooldownMs = cfg.cooldown_ms;
                if (typeof cfg.window_ms === "number") clickConfig.windowMs = cfg.window_ms;
                if (typeof cfg.max_hits === "number") clickConfig.maxHits = cfg.max_hits;
                updateCooldownInfo();
            });
        }

        async function refreshAll() {
            await loadPlayer();
            await loadShopItems();
            await loadAuctions();
            await loadLeaderboards();
        }

        async function loadPlayer() {
            if (!gameState.playerId) return;
            try {
                const res = await apiGet(`/api/player/${gameState.playerId}`);
                const p = res.player;

                gameState.gold = parseInt(p.gold || "0", 10);
                gameState.level = parseInt(p.level || "1", 10);
                gameState.inventory = p.inventory || [];

                document.getElementById("playerName").textContent = p.username;
                document.getElementById("playerGold").textContent = gameState.gold;
                document.getElementById("playerLevel").textContent = gameState.level;

                document.getElementById("totalClicks").textContent = p.total_clicks || 0;
                document.getElementById("clickCombo").textContent = p.current_combo || 0;
                gameState.totalClicks = p.total_clicks || 0;
                gameState.currentCombo = p.current_combo || 0;
                document.getElementById("clickRank").textContent = p.click_rank ? `#${p.click_rank}` : "-";

                renderInventory();
            } catch (err) {
                showNotification("è®€å–ç©å®¶è³‡æ–™å¤±æ•—", "error");
            }
        }

        async function loadShopItems() {
            try {
                const res = await apiGet("/api/shop/items");
                shopItemsCache = res.items || [];
                renderShopItems();
            } catch (err) {
                showNotification("è®€å–å•†åº—å¤±æ•—", "error");
            }
        }

        function renderShopItems() {
            const container = document.getElementById("shopItems");
            if (!shopItemsCache.length) {
                container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">æš«ç„¡å•†å“</p>';
                return;
            }
            container.innerHTML = shopItemsCache
                .map(item => `
                    <div class="item-card">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">ğŸ’° ${item.price}</div>
                        <div class="item-stats">
                            ${item.damage ? `âš”ï¸ æ”»æ“Š: ${item.damage}<br>` : ""}
                            ${item.defense ? `ğŸ›¡ï¸ é˜²ç¦¦: ${item.defense}<br>` : ""}
                            ${item.heal ? `â¤ï¸ æ¢å¾©: ${item.heal}<br>` : ""}
                        </div>
                        <div class="item-stock">åº«å­˜: ${item.stock}</div>
                        <button class="buy-btn"
                            onclick="buyItem('${item.id}')"
                            ${item.stock <= 0 || gameState.gold < item.price ? "disabled" : ""}>
                            è³¼è²·
                        </button>
                    </div>
                `)
                .join("");
        }

        async function buyItem(itemId) {
            if (!gameState.playerId) return;
            try {
                const res = await apiPost("/api/shop/buy", {
                    player_id: gameState.playerId,
                    item_id: itemId,
                    quantity: 1
                });

                if (typeof res.gold === "number") {
                    gameState.gold = res.gold;
                    document.getElementById("playerGold").textContent = gameState.gold;
                }

                showNotification(res.message || "è³¼è²·æˆåŠŸ", "success");
                await refreshAll();
            } catch (err) {
                showNotification(err.data?.message || "è³¼è²·å¤±æ•—", "error");
            }
        }

        function renderInventory() {
            const container = document.getElementById("inventory");
            const inv = gameState.inventory || [];
            if (!inv.length) {
                container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">èƒŒåŒ…æ˜¯ç©ºçš„</p>';
                return;
            }
            container.innerHTML = inv
                .map(item => `
                    <div class="inventory-item">
                        <div>
                            <div><strong>${item.name}</strong></div>
                            <div style="font-size:0.8em;color:#666;">${item.acquired_at}</div>
                        </div>
                        <button onclick="openAuctionModal(${item.unique_id})">ä¸Šæ¶</button>
                    </div>
                `)
                .join("");
        }

        // æ‹è³£
        function openAuctionModal(uniqueId) {
            const item = (gameState.inventory || []).find(i => i.unique_id === uniqueId);
            if (!item) {
                showNotification("æ‰¾ä¸åˆ°ç‰©å“", "error");
                return;
            }
            currentAuctionItem = item;
            document.getElementById("auctionItemName").textContent = item.name;
            document.getElementById("auctionPrice").value = "";
            document.getElementById("auctionModal").style.display = "flex";
        }

        function closeAuctionModal() {
            currentAuctionItem = null;
            document.getElementById("auctionModal").style.display = "none";
        }

        async function confirmAuction() {
            if (!currentAuctionItem || !gameState.playerId) return;
            const price = parseInt(document.getElementById("auctionPrice").value || "0", 10);
            if (!price || price <= 0) {
                showNotification("è«‹è¼¸å…¥æœ‰æ•ˆåƒ¹æ ¼", "error");
                return;
            }
            try {
                await apiPost("/api/auction/create", {
                    player_id: gameState.playerId,
                    unique_id: currentAuctionItem.unique_id,
                    starting_price: price
                });
                showNotification("æ‹è³£å·²ä¸Šæ¶", "success");
                closeAuctionModal();
                await refreshAll();
            } catch (err) {
                showNotification(err.data?.message || "ä¸Šæ¶å¤±æ•—", "error");
            }
        }

        function openBidModal(auctionId) {
            const a = auctionsCache.find(x => x.id === auctionId);
            if (!a) return;
            currentBidAuctionId = auctionId;
            document.getElementById("bidItemName").textContent = a.item_name;
            document.getElementById("bidCurrentPrice").textContent = a.current_price;
            document.getElementById("bidAmount").value = "";
            document.getElementById("bidModal").style.display = "flex";
        }

        function closeBidModal() {
            currentBidAuctionId = null;
            document.getElementById("bidModal").style.display = "none";
        }

        async function confirmBid() {
            if (!currentBidAuctionId || !gameState.playerId) return;
            const amount = parseInt(document.getElementById("bidAmount").value || "0", 10);
            if (!amount || amount <= 0) {
                showNotification("è«‹è¼¸å…¥æœ‰æ•ˆå‡ºåƒ¹", "error");
                return;
            }
            try {
                await apiPost("/api/auction/bid", {
                    auction_id: currentBidAuctionId,
                    player_id: gameState.playerId,
                    bid_amount: amount
                });

                showNotification("å‡ºåƒ¹æˆåŠŸ", "success");
                closeBidModal();
                await refreshAll();
            } catch (err) {
                showNotification(err.data?.message || "å‡ºåƒ¹å¤±æ•—", "error");
            }
        }

        async function buyNow(auctionId) {
            if (!gameState.playerId) return;
            try {
                const res = await apiPost(`/api/auction/buy/${auctionId}`, {
                    player_id: gameState.playerId
                });

                // æ­é…æ–°çš„ server.pyï¼šå›å‚³ buyer_gold, seller_gold
                if (typeof res.buyer_gold === "number") {
                    gameState.gold = res.buyer_gold;
                    document.getElementById("playerGold").textContent = gameState.gold;
                }

                showNotification(res.message || "è³¼è²·æˆåŠŸ", "success");
                await refreshAll();
            } catch (err) {
                showNotification(err.data?.message || "è³¼è²·å¤±æ•—", "error");
            }
        }

        async function loadAuctions() {
            try {
                const res = await apiGet("/api/auction/list");
                auctionsCache = res.auctions || [];
                renderAuctions();
            } catch (err) {
                showNotification("è®€å–æ‹è³£å¤±æ•—", "error");
            }
        }

        function renderAuctions() {
            const container = document.getElementById("auctionMarket");
            if (!auctionsCache.length) {
                container.innerHTML = '<p style="color:#999;text-align:center;padding:20px;">ç›®å‰æ²’æœ‰æ‹è³£</p>';
                return;
            }
            container.innerHTML = auctionsCache
                .map(a => `
                    <div class="auction-item">
                        <div class="auction-header">
                            <div class="auction-item-name">${a.item_name}</div>
                            <div class="auction-price">ğŸ’° ${a.current_price}</div>
                        </div>
                        <div class="auction-seller">
                            è³£å®¶: ${a.seller_name || a.seller}
                            ${a.highest_bidder_name ? `<br>æœ€é«˜å‡ºåƒ¹: ${a.highest_bidder_name}` : ""}
                        </div>
                        <div class="auction-actions">
                            ${a.seller === gameState.playerId
                        ? `<button style="background:#9ca3af;color:white;" disabled>è‡ªå·±ä¸Šæ¶</button>`
                        : `
                                    <button class="bid-btn" onclick="openBidModal('${a.id}')">å‡ºåƒ¹</button>
                                    <button class="bid-btn" onclick="buyNow('${a.id}')">ç«‹å³è³¼è²·</button>
                                `
                    }
                        </div>
                    </div>
                `)
                .join("");
        }

        async function loadLeaderboards() {
            try {
                const goldRes = await apiGet("/api/leaderboard/gold?limit=10");
                const clickRes = await apiGet("/api/leaderboard/clicks?limit=10");

                renderLeaderboard("goldLeaderboard", goldRes.leaderboard, "ğŸ’°");
                renderLeaderboard("clickLeaderboard", clickRes.leaderboard, "ğŸ”¥");
            } catch (err) {
                showNotification("è®€å–æ’è¡Œæ¦œå¤±æ•—", "error");
            }
        }

        function renderLeaderboard(containerId, list, symbol) {
            const container = document.getElementById(containerId);
            if (!list.length) {
                container.innerHTML = '<p style="color:#999;text-align:center;padding:10px;">æš«ç„¡è³‡æ–™</p>';
                return;
            }
            container.innerHTML = list
                .map(entry => `
                    <div class="leaderboard-entry">
                        <span class="rank rank-${entry.rank}">#${entry.rank}</span>
                        <span><strong>${entry.username}</strong></span>
                        <span>${symbol} ${entry.score}</span>
                    </div>
                `)
                .join("");
        }

        async function clickForGold() {
            if (!gameState.playerId) return;
            const btn = document.getElementById("clickButton");
            if (btn.disabled) return;

            btn.disabled = true;

            try {
                const res = await apiPost(`/api/click/${gameState.playerId}`);

                gameState.gold = res.gold;
                gameState.totalClicks = res.total_clicks;
                gameState.currentCombo = res.combo;

                document.getElementById("playerGold").textContent = gameState.gold;
                document.getElementById("totalClicks").textContent = gameState.totalClicks;
                document.getElementById("clickCombo").textContent = gameState.currentCombo;

                if (typeof res.cooldown_ms === "number") {
                    clickConfig.cooldownMs = res.cooldown_ms;
                }
                if (typeof res.rate_limit_window_ms === "number") {
                    clickConfig.windowMs = res.rate_limit_window_ms;
                }
                if (typeof res.rate_limit_max_hits === "number") {
                    clickConfig.maxHits = res.rate_limit_max_hits;
                }
                updateCooldownInfo();

                let msg = `ğŸ’° ç²å¾— ${res.reward} é‡‘å¹£ï¼`;
                if (res.combo > 1) msg += ` (é€£æ“Š x${res.combo})`;
                if (res.critical) msg += " âš¡æš´æ“Š!";
                showNotification(msg, res.critical ? "critical" : "success");

                const delay = Math.max(clickConfig.cooldownMs, 100);
                setTimeout(() => {
                    btn.disabled = false;
                }, delay);

            } catch (err) {
                if (err.status === 429) {
                    const data = err.data || {};
                    let wait = 800;

                    if (typeof data.retry_after_ms === "number") {
                        wait = data.retry_after_ms;
                    } else if (typeof data.cooldown_ms === "number") {
                        wait = data.cooldown_ms;
                    }

                    if (typeof data.cooldown_ms === "number") {
                        clickConfig.cooldownMs = data.cooldown_ms;
                    }
                    if (typeof data.limit_window_ms === "number") {
                        clickConfig.windowMs = data.limit_window_ms;
                    }
                    if (typeof data.limit_max_hits === "number") {
                        clickConfig.maxHits = data.limit_max_hits;
                    }
                    updateCooldownInfo();

                    const msg = data.message || "å†·å»ä¸­ï¼Œè«‹ç¨å¾Œå†é»";
                    showNotification(msg, "error");

                    setTimeout(() => {
                        btn.disabled = false;
                    }, Math.max(wait, 200));
                } else {
                    showNotification(err.data?.message || "é»æ“Šå¤±æ•—", "error");
                    setTimeout(() => {
                        btn.disabled = false;
                    }, 800);
                }
            }
        }

        async function logout() {
            try {
                await apiPost("/api/player/logout", {});
            } catch (e) { }
            gameState = {
                playerId: null,
                username: "",
                gold: 0,
                level: 1,
                inventory: [],
                totalClicks: 0,
                currentCombo: 0
            };
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            document.getElementById("gameContainer").style.display = "none";
            document.getElementById("loginScreen").style.display = "flex";
        }

        function switchAccount() {
            logout();
        }

        function showNotification(message, type = "success") {
            const notification = document.createElement("div");
            notification.className = `notification ${type}`;
            notification.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = "slideIn 0.3s ease-out reverse";
                setTimeout(() => notification.remove(), 300);
            }, 2500);
        }

        // å‡ºåƒ¹è¼¸å…¥æ¡† Enter é€å‡º
        const bidInput = document.getElementById("bidAmount");
        if (bidInput) {
            bidInput.addEventListener("keydown", function (e) {
                if (e.key === "Enter" || e.keyCode === 13) {
                    e.preventDefault();
                    confirmBid();
                }
            });
        }

    </script>
</body>

</html>
