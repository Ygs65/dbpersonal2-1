<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title>éŠæˆ²ç®¡ç†å¾Œå° - é»æ“Šå†·å» / é™æµè¨­å®š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937 0%, #020617 55%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      padding: 24px;
    }

    h1,
    h2 {
      color: #facc15;
    }

    .card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      padding: 22px 20px;
      margin-bottom: 18px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, .55);
      border: 1px solid #1f2937;
    }

    label {
      display: block;
      margin-top: 8px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    input[type="number"] {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      box-sizing: border-box;
      outline: none;
    }

    input[type="number"]:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3);
    }

    button {
      margin-top: 12px;
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #022c22;
      font-weight: 700;
      cursor: pointer;
      transition: transform .1s ease, box-shadow .1s ease, background .1s ease;
    }

    button:hover {
      background: #16a34a;
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.45);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .col {
      flex: 1 1 260px;
    }

    .hint {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .status {
      margin-top: 12px;
      font-size: 14px;
    }

    .status.ok {
      color: #4ade80;
    }

    .status.err {
      color: #fb7185;
    }

    a {
      color: #38bdf8;
    }

    /* Admin ç™»å…¥é®ç½© */
    .admin-login-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.93), rgba(15, 23, 42, 0.98));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5000;
      backdrop-filter: blur(6px);
    }

    .admin-login-card {
      background: #020617;
      padding: 28px 26px 26px;
      border-radius: 18px;
      width: 360px;
      max-width: calc(100% - 32px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
      color: #f9fafb;
      border: 1px solid #1f2937;
      animation: popIn .2s ease-out;
    }

    .admin-login-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      justify-content: center;
    }

    .admin-login-icon {
      font-size: 26px;
    }

    .admin-login-title {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 1px;
      color: #facc15;
    }

    .admin-login-sub {
      text-align: center;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 18px;
    }

    .password-label {
      font-size: 14px;
      margin-bottom: 4px;
    }

    .password-wrapper {
      position: relative;
      margin-top: 2px;
    }

    .password-wrapper input {
      width: 100%;
      padding: 11px 44px 11px 13px;
      border-radius: 999px;
      border: 1px solid #334155;
      background: #020617;
      color: #e5e7eb;
      outline: none;
      font-size: 14px;
    }

    .password-wrapper input::placeholder {
      color: #6b7280;
    }

    .password-wrapper input:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
    }

    .toggle-pass {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #9ca3af;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
    }

    .toggle-pass:hover {
      color: #e5e7eb;
    }

    .admin-login-btn {
      width: 100%;
      padding: 11px;
      border-radius: 999px;
      background: #22c55e;
      color: #022c22;
      font-size: 15px;
      font-weight: 800;
      margin-top: 18px;
    }

    .login-status {
      margin-top: 10px;
      font-size: 13px;
      color: #fca5a5;
      min-height: 18px;
      text-align: center;
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: translateY(6px) scale(0.97);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @media (max-width: 600px) {
      body {
        padding: 16px;
      }

      .card {
        padding: 18px 16px;
      }
    }
  </style>
</head>

<body>
  <!-- Admin Login Screen -->
  <div id="adminLoginScreen" class="admin-login-overlay">
    <div class="admin-login-card">
      <div class="admin-login-title-row">
        <span class="admin-login-icon">ğŸ”’</span>
        <span class="admin-login-title">ç®¡ç†å“¡ç™»å…¥</span>
      </div>
      <div class="admin-login-sub">è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼ï¼Œä»¥é€²å…¥ Redis éŠæˆ²å¾Œå°</div>

      <div class="password-label">ç®¡ç†å¯†ç¢¼</div>
      <div class="password-wrapper">
        <input type="password" id="adminPasswordInput" placeholder="è«‹è¼¸å…¥ç®¡ç†è€…å¯†ç¢¼" />
        <button id="togglePassBtn" class="toggle-pass" type="button">ğŸ‘</button>
      </div>

      <button id="adminLoginBtn" class="admin-login-btn" type="button">ç™»å…¥</button>

      <div id="adminLoginStatus" class="login-status"></div>
    </div>
  </div>

  <h1>éŠæˆ²ç®¡ç†å¾Œå°</h1>
  <p>é€™å€‹é é¢å¯ä»¥å³æ™‚èª¿æ•´ã€Œé»æ“Šå†·å»ã€èˆ‡ã€Œæ»‘å‹•è¦–çª—é™æµã€è¨­å®šï¼Œ<br>ä¸éœ€è¦é‡æ–°éƒ¨ç½² Renderï¼Œå°±èƒ½æ”¹è®ŠéŠæˆ²ç¯€å¥ã€‚</p>

  <div class="card">
    <h2>ç›®å‰è¨­å®šå€¼</h2>
    <div id="current-config">
      ï¼ˆè«‹å…ˆç™»å…¥ç®¡ç†è€…ï¼‰
    </div>
  </div>

  <div class="row">
    <div class="card col">
      <h2>é»æ“Šå†·å»æ™‚é–“ï¼ˆå–®æ¬¡å†·å»ï¼‰</h2>
      <label for="cooldown_ms">å†·å»æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰</label>
      <input type="number" id="cooldown_ms" min="0" step="50" value="500" />
      <div class="hint">
        ä¾‹å¦‚ï¼š500 = 0.5ç§’ï¼Œ1000 = 1ç§’ï¼Œ0 = ç„¡å†·å»ï¼ˆå±éšªã€ä¸å»ºè­°ï¼‰ã€‚
      </div>
      <button id="btn-set-cooldown">æ›´æ–°å†·å»è¨­å®š</button>
      <div id="status-cooldown" class="status"></div>
    </div>

    <div class="card col">
      <h2>æ»‘å‹•è¦–çª—é™æµï¼ˆé˜²æš´åŠ›é€£é»ï¼‰</h2>
      <label for="window_ms">è¦–çª—é•·åº¦ï¼ˆæ¯«ç§’ï¼‰</label>
      <input type="number" id="window_ms" min="100" step="100" value="1000" />
      <div class="hint">
        ä¾‹å¦‚ï¼š1000 = æœ€è¿‘ 1 ç§’ã€3000 = æœ€è¿‘ 3 ç§’ã€‚
      </div>

      <label for="max_hits">è¦–çª—å…§æœ€å¤§é»æ“Šæ¬¡æ•¸</label>
      <input type="number" id="max_hits" min="1" step="1" value="3" />
      <div class="hint">
        ä¾‹å¦‚ï¼š1ç§’å…§æœ€å¤š 3 æ¬¡ï¼Œè¶…éå°±æœƒè¢«æ“‹ä¸‹ã€‚
      </div>

      <button id="btn-set-rate">æ›´æ–°é™æµè¨­å®š</button>
      <div id="status-rate" class="status"></div>
    </div>
  </div>

  <div class="card">
    <h2>å°æé†’</h2>
    <ul>
      <li>é€™å€‹é é¢å·²æœ‰ç°¡æ˜“å¯†ç¢¼ä¿è­·ï¼Œæ­£å¼ç’°å¢ƒä»å»ºè­°æ­é… VPN / æ ¡å…§ç¶²è·¯ã€‚</li>
      <li>å‰ç«¯éŠæˆ²æœƒè‡ªå‹•å¥—ç”¨æ–°çš„è¨­å®šï¼Œä¸éœ€è¦é‡å•Ÿä¼ºæœå™¨ã€‚</li>
      <li>å¦‚æœè¨­å®šå¤ªæ¥µç«¯ï¼ˆä¾‹å¦‚ 0ms å†·å»ã€1ç§’100æ¬¡ï¼‰ï¼Œå¯èƒ½æœƒè®“ Redis å£“åŠ›è®Šå¤§ã€‚</li>
    </ul>
    <p class="hint">
      ç›®å‰éŠæˆ²é¦–é ï¼š<a href="/">å›åˆ°éŠæˆ²é¦–é </a>
    </p>
  </div>

  <script>
    // é€™å€‹è®Šæ•¸å­˜ã€Œç›®å‰ç™»å…¥æˆåŠŸçš„å¯†ç¢¼ã€ï¼Œæ¯æ¬¡å‘¼å« /admin API éƒ½æœƒå¸¶ä¸Šå»
    let ADMIN_PASSWORD = "";

    // DOM æŠ“å–
    const loginScreen = document.getElementById("adminLoginScreen");
    const passInput = document.getElementById("adminPasswordInput");
    const loginBtn = document.getElementById("adminLoginBtn");
    const statusText = document.getElementById("adminLoginStatus");
    const toggleBtn = document.getElementById("togglePassBtn");

    // æŒ‰ Enter ä¹Ÿå¯ä»¥ç™»å…¥
    passInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        loginAdmin();
      }
    });

    // æŒ‰éˆ•ç™»å…¥
    loginBtn.addEventListener("click", loginAdmin);

    // é¡¯ç¤º / éš±è—å¯†ç¢¼
    toggleBtn.addEventListener("click", () => {
      if (passInput.type === "password") {
        passInput.type = "text";
        toggleBtn.textContent = "ğŸ™ˆ";
      } else {
        passInput.type = "password";
        toggleBtn.textContent = "ğŸ‘";
      }
    });

    async function loginAdmin() {
      const inputPass = passInput.value.trim();
      statusText.textContent = "";

      if (!inputPass) {
        statusText.textContent = "è«‹è¼¸å…¥å¯†ç¢¼ï¼";
        return;
      }

      // å…ˆæš«å­˜ï¼Œå†å»æ‰“ /admin/config è©¦è©¦çœ‹
      ADMIN_PASSWORD = inputPass;
      statusText.textContent = "é©—è­‰ä¸­â€¦";

      const ok = await fetchConfig(true);
      if (ok) {
        loginScreen.style.display = "none";
      } else {
        ADMIN_PASSWORD = "";
        statusText.textContent = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡";
      }
    }

    // å¾å¾Œç«¯è®€å–è¨­å®š
    async function fetchConfig(isLoginAttempt = false) {
      const target = document.getElementById('current-config');
      try {
        const res = await fetch('/admin/config', {
          headers: { "X-ADMIN-PASS": ADMIN_PASSWORD }
        });

        if (res.status === 401) {
          if (!isLoginAttempt) {
            target.innerText = 'å°šæœªç™»å…¥æˆ–æœªæˆæ¬Š';
          }
          return false;
        }

        const data = await res.json();
        if (!data.success) {
          target.innerText = 'è®€å–è¨­å®šå¤±æ•—';
          return false;
        }

        target.innerText =
          `å†·å»ï¼š${data.cooldown_ms} ms\n` +
          `æ»‘å‹•è¦–çª—ï¼š${data.window_ms} ms\n` +
          `è¦–çª—å…§æœ€å¤§é»æ“Šï¼š${data.max_hits} æ¬¡`;

        document.getElementById('cooldown_ms').value = data.cooldown_ms;
        document.getElementById('window_ms').value = data.window_ms;
        document.getElementById('max_hits').value = data.max_hits;

        if (isLoginAttempt) {
          statusText.textContent = "ç™»å…¥æˆåŠŸï¼";
        }
        return true;
      } catch (e) {
        target.innerText = 'è®€å–è¨­å®šç™¼ç”ŸéŒ¯èª¤';
        if (isLoginAttempt) {
          statusText.textContent = "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
        }
        return false;
      }
    }

    // æ›´æ–°å†·å»æ™‚é–“
    async function setCooldown() {
      const val = parseInt(document.getElementById('cooldown_ms').value || '0', 10);
      const status = document.getElementById('status-cooldown');
      status.innerText = 'é€å‡ºä¸­â€¦';
      status.className = 'status';

      try {
        const res = await fetch('/admin/set_cooldown', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-ADMIN-PASS': ADMIN_PASSWORD
          },
          body: JSON.stringify({ cooldown_ms: val })
        });
        const data = await res.json();
        if (res.status === 401 || !data.success) {
          status.innerText = 'æœªæˆæ¬Šæˆ–æ›´æ–°å¤±æ•—';
          status.className = 'status err';
          return;
        }
        status.innerText = `å·²æ›´æ–°å†·å»ï¼š${data.cooldown_ms} ms`;
        status.className = 'status ok';
        fetchConfig();
      } catch (e) {
        status.innerText = 'æ›´æ–°éç¨‹å‡ºéŒ¯';
        status.className = 'status err';
      }
    }

    // æ›´æ–°æ»‘å‹•è¦–çª—é™æµè¨­å®š
    async function setRateLimit() {
      const windowMs = parseInt(document.getElementById('window_ms').value || '1000', 10);
      const maxHits = parseInt(document.getElementById('max_hits').value || '3', 10);
      const status = document.getElementById('status-rate');
      status.innerText = 'é€å‡ºä¸­â€¦';
      status.className = 'status';

      try {
        const res = await fetch('/admin/set_rate_limit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-ADMIN-PASS': ADMIN_PASSWORD
          },
          body: JSON.stringify({ window_ms: windowMs, max_hits: maxHits })
        });
        const data = await res.json();
        if (res.status === 401 || !data.success) {
          status.innerText = 'æœªæˆæ¬Šæˆ–æ›´æ–°å¤±æ•—';
          status.className = 'status err';
          return;
        }
        status.innerText =
          `å·²æ›´æ–°æ»‘å‹•è¦–çª—ï¼š${data.window_ms} msï¼Œè¦–çª—å…§æœ€å¤§é»æ“Šï¼š${data.max_hits} æ¬¡`;
        status.className = 'status ok';
        fetchConfig();
      } catch (e) {
        status.innerText = 'æ›´æ–°éç¨‹å‡ºéŒ¯';
        status.className = 'status err';
      }
    }

    document.getElementById('btn-set-cooldown').addEventListener('click', setCooldown);
    document.getElementById('btn-set-rate').addEventListener('click', setRateLimit);
  </script>
</body>

</html>
